<ion-content
  class="bg-gradient-to-br from-[#FFF0E6] via-white to-[#FFE0D0] dark:from-gray-900 dark:via-gray-800 dark:to-[#3E2A23]"
  scrollEvents="true"
  [scrollY]="true"
  forceOverscroll="true"
  (ionRefresh)="doRefresh($event)"
>
  <ion-refresher slot="fixed">
    <ion-refresher-content
      pullingIcon=""
      pullingText=""
      refreshingSpinner="circles"
      refreshingText="">
    </ion-refresher-content>
  </ion-refresher>

  <div class="px-4 sm:px-6 pt-4 pb-3 bg-white dark:bg-gray-900 shadow-sm border-b border-gray-200 dark:border-gray-800 fixed top-0 left-0 right-0 z-10">
    <div class="flex items-center">
      <div class="ml-2">
        <h2 class="text-base font-medium text-gray-800 dark:text-gray-100">
          Riwayat Surat
        </h2>
        <p class="text-gray-500 dark:text-gray-400 text-xs mt-0.5">
          Lihat dan kelola riwayat pengajuan surat Anda
        </p>
      </div>
    </div>
  </div>

  <div class="bg-gradient-to-br from-[#FFF0E6] via-white to-[#FFE0D0] dark:from-gray-900 dark:via-gray-800 dark:to-[#3E2A23] min-h-screen p-4 pt-20">
    <!-- Empty state when no letters exist -->
    <div *ngIf="riwayatSurat.length === 0" class="flex flex-col items-center justify-center min-h-[70vh] px-4 text-center">
      <div class="w-24 h-24 bg-[#FFF0E6] dark:bg-gray-800 rounded-full flex items-center justify-center mb-4">
        <ion-icon name="document-outline" class="text-4xl text-[#BB3E00] dark:text-[#FF8C5A]"></ion-icon>
      </div>
      <h3 class="text-lg font-medium text-gray-800 dark:text-gray-200 mb-2">Belum Ada Riwayat</h3>
      <p class="text-sm text-gray-500 dark:text-gray-400 max-w-md mb-6">
        Anda belum memiliki riwayat pengajuan surat. Silakan buat surat baru melalui menu Aktivitas.
      </p>
      <ion-button color="primary" routerLink="/pengajuansurat" expand="block" class="w-full max-w-xs" style="--background: #BB3E00; --background-activated: #A03500; --background-hover: #A03500;">
        <ion-icon name="add-outline" slot="start"></ion-icon>
        Buat Surat Baru
      </ion-button>
    </div>

    <!-- Letters history list -->
    <div *ngIf="riwayatSurat.length > 0" class="space-y-3">
      <!-- Filter and sort controls - fixed position -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-3 mb-3">
        <div class="flex flex-wrap items-center justify-between gap-2">
          <div class="flex items-center">
            <ion-icon name="funnel-outline" class="text-[#BB3E00] dark:text-[#FF8C5A] mr-2"></ion-icon>
            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Filter</span>
          </div>
          <div class="flex space-x-1">
            <ion-button size="small" fill="clear" class="text-xs h-8 rounded-md" 
              [ngClass]="{'bg-[#FFF0E6] dark:bg-gray-700 text-[#BB3E00] dark:text-[#FF8C5A]': filterMode === 'all', 'text-gray-600 dark:text-gray-400': filterMode !== 'all'}"
              (click)="setFilterMode('all')">
              Semua
            </ion-button>
            <ion-button size="small" fill="clear" class="text-xs h-8 rounded-md" 
              [ngClass]="{'bg-[#FFF0E6] dark:bg-gray-700 text-[#BB3E00] dark:text-[#FF8C5A]': filterMode === 'newest', 'text-gray-600 dark:text-gray-400': filterMode !== 'newest'}"
              (click)="sortByNewest()">
              Terbaru
            </ion-button>
            <ion-button size="small" fill="clear" class="text-xs h-8 rounded-md" 
              [ngClass]="{'bg-[#FFF0E6] dark:bg-gray-700 text-[#BB3E00] dark:text-[#FF8C5A]': filterMode === 'oldest', 'text-gray-600 dark:text-gray-400': filterMode !== 'oldest'}"
              (click)="sortByOldest()">
              Terlama
            </ion-button>
          </div>
        </div>
      </div>

      <!-- Letters list with improved scroll behavior -->
      <div class="pb-3 space-y-3">
        <div *ngFor="let surat of riwayatSurat; let i = index" class="relative">
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden transform transition-all duration-200 hover:translate-y-[-2px] hover:shadow-md will-change-transform">
            <!-- Status badge -->
            <div class="absolute top-0 right-0 mt-3 mr-3">
              <!-- Disetujui -->
              <span *ngIf="surat.status === 'Disetujui'" class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200">
                <span class="w-2 h-2 rounded-full bg-green-500 dark:bg-green-400 mr-1"></span>
                Disetujui
              </span>
              <!-- Proses -->
              <span *ngIf="surat.status === 'Proses' || !surat.status" class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">
                <span class="w-2 h-2 rounded-full bg-blue-500 dark:bg-blue-400 mr-1"></span>
                Proses
              </span>
              <!-- Ditolak -->
              <span *ngIf="surat.status === 'Ditolak'" class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200">
                <span class="w-2 h-2 rounded-full bg-red-500 dark:bg-red-400 mr-1"></span>
                Ditolak
              </span>
            </div>
            
            <!-- Letter content -->
            <div class="p-4">
              <div class="flex items-start mb-3">
                <div class="w-10 h-10 rounded-full bg-[#FFF0E6] dark:bg-[#3E2A23] flex items-center justify-center flex-shrink-0">
                  <ion-icon name="document-text-outline" class="text-[#BB3E00] dark:text-[#FF8C5A] text-lg"></ion-icon>
                </div>
                <div class="ml-3 flex-1">
                  <div class="flex justify-between items-start">
                    <div>
                      <h3 class="text-sm font-semibold text-gray-800 dark:text-gray-100">{{ surat.title }}</h3>
                      <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">{{ surat.suratNumber }}</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Timestamp with date and time -->
              <div class="bg-gray-50 dark:bg-gray-900 rounded-md p-2 mb-3">
                <div class="flex items-center">
                  <ion-icon name="calendar-outline" class="text-[#BB3E00] dark:text-[#FF8C5A] mr-2 text-sm"></ion-icon>
                  <div class="flex flex-col">
                    <span class="text-xs font-medium text-gray-700 dark:text-gray-300">Diajukan pada:</span>
                    <div class="flex items-center mt-0.5">
                      <span class="text-xs text-gray-600 dark:text-gray-400">{{ surat.date }}</span>
                      <span class="mx-1 text-gray-400 dark:text-gray-500">â€¢</span>
                      <span class="text-xs text-gray-600 dark:text-gray-400">{{ surat.time || '14:30' }} WIB</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Action buttons -->
              <div class="flex justify-between items-center pt-3 border-t border-gray-100 dark:border-gray-700">
                <div class="flex space-x-2">
                  <ion-button size="small" fill="clear" color="medium" class="text-xs dark:text-gray-300">
                    <ion-icon name="download-outline" slot="start" size="small" class="dark:text-gray-300"></ion-icon>
                    <span class="hidden sm:inline">Unduh</span>
                  </ion-button>
                </div>
                <div class="flex space-x-1">
                  <ion-button size="small" fill="outline" color="danger" class="text-xs" (click)="deleteSurat(i)">
                    <ion-icon name="trash-outline" slot="icon-only" size="small"></ion-icon>
                  </ion-button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Clear history button -->
      <div *ngIf="riwayatSurat.length > 0" class="mt-6 flex justify-center">
        <ion-button 
          color="medium" 
          fill="outline"
          (click)="clearAllHistory()" 
          class="w-full max-w-xs text-sm dark:text-gray-300 dark:border-gray-600"
        >
          <ion-icon name="trash-outline" slot="start" class="dark:text-gray-300"></ion-icon>
          Hapus Semua Riwayat
        </ion-button>
      </div>
      
    </div>
  </div>
</ion-content>

<ion-tab-bar slot="bottom" class="bg-white dark:bg-gray-900 border-t border-gray-100 dark:border-gray-800 h-16">
  <ion-tab-button
    tab="dashboard"
    routerLink="/dashboard"
    routerDirection="root"
    routerLinkActive="tab-selected"
    class="text-xs"
  >
    <div class="flex flex-col items-center justify-center">
      <div class="w-6 h-6 flex items-center justify-center mb-1">
        <ion-icon name="grid" class="text-xl"></ion-icon>
      </div>
      <ion-label>Beranda</ion-label>
    </div>
  </ion-tab-button>

  <ion-tab-button
    tab="aktivitas"
    routerLink="/aktivitas"
    routerDirection="root"
    routerLinkActive="tab-selected"
    class="text-xs"
  >
    <div class="flex flex-col items-center justify-center">
      <div class="w-6 h-6 flex items-center justify-center mb-1">
        <ion-icon name="pulse" class="text-xl"></ion-icon>
      </div>
      <ion-label>Aktivitas</ion-label>
    </div>
  </ion-tab-button>

  <ion-tab-button
    tab="riwayat"
    routerLink="/riwayatsurat"
    routerDirection="root"
    routerLinkActive="tab-selected"
    class="text-xs"
  >
    <div class="flex flex-col items-center justify-center">
      <div class="w-6 h-6 flex items-center justify-center mb-1">
        <ion-icon name="time" class="text-xl"></ion-icon>
      </div>
      <ion-label>Riwayat</ion-label>
    </div>
  </ion-tab-button>

  <ion-tab-button
    tab="profile"
    routerLink="/profile"
    routerDirection="root"
    routerLinkActive="tab-selected"
    class="text-xs"
  >
    <div class="flex flex-col items-center justify-center">
      <div class="w-6 h-6 flex items-center justify-center mb-1">
        <ion-icon name="person" class="text-xl"></ion-icon>
      </div>
      <ion-label>Profil</ion-label>
    </div>
  </ion-tab-button>
</ion-tab-bar>